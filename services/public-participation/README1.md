## License

This project is licensed under the [MIT License](LICENSE).


# Public-Participation
 A project towards increasing awareness of legislative processes amongst the public

Summary of File Placement
File/Folder	New Location	Purpose
__pycache__/	Root (/)	Automatically generated by Python. Should be ignored via .gitignore.
alembic/	migrations/	Database migration scripts managed by Alembic.
bills_pdfs/	data/bills_pdfs/	Stores PDF files of bills.
processed_bills/	data/processed_bills/	Stores processed versions of bills.
.env	config/.env	Stores environment variables.
.gitattributes	Root (/)	Git configuration file.
ai_model.log	logs/ai_model.log	Log file for AI model activities.
ai_model1.py	modules/ai_model.py	Refactored AI model script containing the OllamaResponder class.
alembic.ini	config/alembic.ini	Alembic configuration file.
app.log	logs/app.log	General application log file.
bills.db	data/bills.db	SQLite database file containing bills data.
database_setup.log	logs/database_setup.log	Log file for database setup activities.
database_setup.py	scripts/database_setup.py	Script to set up the database schema.
env.py	scripts/env.py	Environment setup script (ensure it's necessary; otherwise, consider removing).
main_phase1.py	scripts/main_phase1.py	Main script for the first phase of the project.
pdf_processor.log	logs/pdf_processor.log	Log file for PDF processing activities.
pdf_processor.py	scripts/pdf_processor.py	Script to process PDF files and extract information.
README.md	Root (/)	Project documentation.
scraper.py	scripts/scraper.py	Web scraping script to gather data.
test_search_bills.py	tests/test_search_bills.py	Unit tests for the bill search functionality.
test_whatsapp.py	tests/test_whatsapp.py	Unit tests for the WhatsApp bot functionality.
test.py	tests/test_ai_model.py	Renamed and moved to tests/ for testing the AI model.
verify_bills.py	scripts/verify_bills.py	Script to verify the integrity or accuracy of bills.
verify_bills.log	logs/verify_bills.log	Log file for bill verification activities.
whatsapp_bot.log	logs/whatsapp_bot.log	Log file for WhatsApp bot activities.
whatsapp_bot.py	scripts/whatsapp_bot.py	Script managing the WhatsApp bot functionalities.

# Public Participation AI System

## Overview

This project implements a Retrieval Augmented Generation (RAG) system integrated with a Knowledge Graph to enhance the Ollama AI model's responses based on a structured knowledge bank.

## Directory Structure
Public-Participation/ ├── config/ │ ├── .env │ └── alembic.ini ├── data/ │ └── bills_pdfs/ ├── logs/ │ ├── ai_model.log │ ├── app.log │ ├── database_setup.log │ ├── pdf_processor.log │ ├── verify_bills.log │ └── whatsapp_bot.log ├── migrations/ │ └── alembic/ ├── modules/ │ ├── init.py │ ├── ai_model.py │ ├── knowledge_graph.py │ └── rag_system.py ├── scripts/ │ ├── database_setup.py │ ├── pdf_processor.py │ ├── scraper.py │ ├── verify_bills.py │ └── whatsapp_bot.py ├── tests/ │ ├── test_ai_model.py │ ├── test_search_bills.py │ └── test_whatsapp.py ├── README.md ├── requirements.txt └── .gitignore

## Setup Instructions

1. **Clone the Repository:**
    ```bash
    git clone https://github.com/yourusername/Public-Participation.git
    cd Public-Participation
    ```

2. **Create a Virtual Environment:**
    ```bash
    python -m venv venv
    # Activate the virtual environment
    # Windows:
    venv\Scripts\activate
    # Unix or MacOS:
    source venv/bin/activate
    ```

3. **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

4. **Configure Environment Variables:**
    - Rename `.env.example` to `.env` and update the variables accordingly.

5. **Set Up the Knowledge Graph:**
    ```bash
    python scripts/database_setup.py
    python scripts/pdf_processor.py
    ```
    - These scripts will set up the database and populate the knowledge graph.

6. **Run the AI Model:**
    ```bash
    python modules/ai_model.py
    ```

7. **Run Tests:**
    ```bash
    python -m unittest discover tests
    ```

## Usage

- **AI Model (`ai_model.py`):** Handles user prompts, retrieves relevant information from the knowledge graph, and generates responses using the Ollama model.

- **PDF Processor (`pdf_processor.py`):** Processes PDF files of bills and extracts necessary information.

- **Scraper (`scraper.py`):** Gathers data from external sources to populate the knowledge graph.

- **WhatsApp Bot (`whatsapp_bot.py`):** Manages interactions via WhatsApp.

## Troubleshooting

- **Connection Errors:**
    - Ensure that the Neo4j server is running and accessible.
    - Verify that the `NEO4J_URI`, `NEO4J_USER`, and `NEO4J_PASSWORD` in your `.env` file are correct.
    - Check firewall settings to ensure that the necessary ports are open.

- **Empty Responses:**
    - Confirm that the knowledge graph has been populated with relevant data.
    - Ensure that the prompt matches the data entries in the knowledge graph.

## Contributing

Contributions are welcome! Please open an issue or submit a pull request for any improvements or bug fixes.

## License

[MIT License](LICENSE)



# Kenya Bills WhatsApp Assistant

![Project Logo](path/to/logo.png) *(Replace with your project logo if available)*

## Table of Contents

- [Introduction](#introduction)
- [Features](#features)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Configuration](#configuration)
  - [.env File Setup](#env-file-setup)
  - [Twilio WhatsApp Sandbox Configuration](#twilio-whatsapp-sandbox-configuration)
  - [ngrok Setup](#ngrok-setup)
  - [Neo4j Knowledge Graph Setup](#neo4j-knowledge-graph-setup)
- [Running the Application](#running-the-application)
- [Usage](#usage)
  - [Sending a List of Bills](#sending-a-list-of-bills)
  - [Querying a Specific Bill](#querying-a-specific-bill)
- [Logging](#logging)
- [Troubleshooting](#troubleshooting)
- [Contributing](#contributing)
- [License](#license)
- [Acknowledgements](#acknowledgements)

## Introduction

The **Kenya Bills WhatsApp Assistant** is an intelligent chatbot designed to interact with users via WhatsApp, providing detailed information about Kenyan legislative bills. Leveraging Twilio's WhatsApp API, a Neo4j knowledge graph, and an AI model powered by Ollama, this assistant can:

- **List Bills:** Provide users with a comprehensive list of Kenyan bills grouped by year.
- **Detail Specific Bills:** Offer in-depth information about specific bills upon user request.

## Features

- **WhatsApp Integration:** Seamlessly interacts with users through WhatsApp messages.
- **Knowledge Graph:** Utilizes Neo4j to store and query detailed information about Kenyan bills.
- **AI-Powered Responses:** Generates intelligent and context-aware responses using Ollama's AI model.
- **Fuzzy Matching:** Implements fuzzy string matching to accurately interpret and respond to user queries, even with typos or varied phrasings.
- **Duplicate Handling:** Ensures unique bill entries are presented to users, eliminating duplicates from responses.
- **Logging:** Comprehensive logging for monitoring and troubleshooting.

## Architecture

![Architecture Diagram](path/to/architecture_diagram.png) *(Replace with your architecture diagram if available)*

1. **Flask Web Server:** Handles incoming HTTP requests from Twilio's webhook.
2. **Twilio WhatsApp API:** Facilitates sending and receiving WhatsApp messages.
3. **Neo4j Knowledge Graph:** Stores detailed information about Kenyan bills.
4. **Ollama AI Model:** Processes user queries and generates intelligent responses based on knowledge graph data.
5. **ngrok:** Exposes the local Flask server to the internet for Twilio webhook integration.

## Prerequisites

Before setting up the project, ensure you have the following installed:

- **Python 3.7 or higher**
- **pip** (Python package installer)
- **Virtual Environment Tool:** `venv` or `virtualenv`
- **Neo4j Database:** Community or Enterprise Edition
- **ngrok:** For tunneling local server to the internet
- **Twilio Account:** With WhatsApp Sandbox enabled
- **Ollama:** Installed and running AI model (`llama3.2:latest`)

## Installation

### 1. Clone the Repository

```bash
git clone https://github.com/yourusername/kenya-bills-whatsapp-assistant.git
cd kenya-bills-whatsapp-assistant
```

### 2. Set Up a Virtual Environment

It's recommended to use a virtual environment to manage project dependencies.

```bash
# Create a virtual environment named 'venv'
python -m venv venv

# Activate the virtual environment
# On Windows:
venv\Scripts\activate

# On macOS and Linux:
source venv/bin/activate
```

### 3. Install Dependencies

Ensure you have `pip` updated to the latest version.

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

## Configuration

### 1. `.env` File Setup

Create a `.env` file in the `config/` directory with the following environment variables:

```dotenv
# config/.env

# Flask configuration
FLASK_APP=app.py
FLASK_ENV=development

# Twilio configuration
TWILIO_ACCOUNT_SID=your_twilio_account_sid
TWILIO_AUTH_TOKEN=your_twilio_auth_token
TWILIO_WHATSAPP_NUMBER=whatsapp:+your_twilio_whatsapp_number

# Neo4j configuration
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=your_neo4j_password

# Ollama configuration
OLLAMA_API_KEY=your_ollama_api_key  # Uncomment if authentication is required
```

*Replace placeholder values (`your_twilio_account_sid`, etc.) with your actual credentials.*

### 2. Twilio WhatsApp Sandbox Configuration

1. **Log in** to your [Twilio Console](https://www.twilio.com/console).
2. Navigate to **Messaging > Try it Out > WhatsApp Sandbox**.
3. In the **Sandbox Configuration**, set the **"WHEN A MESSAGE COMES IN"** webhook URL to your ngrok URL appended with `/whatsapp`. For example:

   ```
   https://<your-ngrok-id>.ngrok.io/whatsapp
   ```

4. **Join the Sandbox:** Send the provided code from the Twilio Console to the designated WhatsApp number to activate the sandbox.

### 3. ngrok Setup

ngrok exposes your local Flask server to the internet, allowing Twilio to send webhooks.

1. **Download and Install ngrok** from [ngrok.com](https://ngrok.com/).
2. **Run ngrok** to forward port `5000` (default Flask port):

   ```bash
   ngrok http 5000
   ```

3. **Note the HTTPS Forwarding URL** provided by ngrok. Update the Twilio webhook URL if ngrok restarts and generates a new URL.

### 4. Neo4j Knowledge Graph Setup

1. **Install Neo4j:** Follow the installation instructions from the [official Neo4j website](https://neo4j.com/download/).
2. **Start Neo4j:** Launch the Neo4j Desktop application or start the Neo4j server.
3. **Create a New Database:** Set up a database to store bill information.
4. **Populate the Knowledge Graph:** Insert nodes representing bills with properties such as `title`, `description`, `file_path`, `url`, etc.
5. **Ensure Unique Bills:** Avoid duplicate entries by ensuring each bill has a unique `title`.

   *Sample Cypher Query to Create a Bill Node:*

   ```cypher
   CREATE (b:Bill {
       title: "The Kenya Revenue Authority Amendment Bill 2024.pdf",
       description: "SPECIAL ISSUE ...",
       file_path: "bills_pdfs/TheKenyaRevenueAuthority_Amendment_Bill_2024.pdf",
       url: "https://kenyalaw.org/kl/fileadmin/pdfdownloads/bills/2024/TheKenyaRevenueAuthority_Amendment_Bill_2024.pdf"
   })
   ```

## Running the Application

1. **Activate the Virtual Environment:**

   ```bash
   # On Windows:
   venv\Scripts\activate

   # On macOS and Linux:
   source venv/bin/activate
   ```

2. **Start the Flask Server:**

   ```bash
   python modules/ai_model.py
   ```

   *Ensure that your Flask app (`app.py`) is correctly set up to use the `OllamaResponder` class.*

3. **Run ngrok:**

   If not already running, start ngrok to expose your Flask server:

   ```bash
   ngrok http 5001
   ```

4. **Verify Connections:**

   - **Twilio:** Ensure the webhook URL is correctly set to your ngrok URL.
   - **Neo4j:** Confirm that the Flask app can connect to your Neo4j database.
   - **Ollama:** Verify that Ollama is running and accessible at the specified `base_url`.

## Usage

Interact with the assistant via WhatsApp using the configured Twilio sandbox number.

### Sending a List of Bills

**Prompt Example:**

```
Can you provide a list of bills in Kenya?
```

**Expected Behavior:**

The assistant responds with a list of Kenyan bills grouped by year. For example:

```
List of Bills in Kenya grouped by year:

Year 2024:
- The Kenya Revenue Authority Amendment Bill 2024.pdf
- The Tax Procedures (Amendment) Bill 2024.pdf
- ...

Year 2023:
- ...
```

### Querying a Specific Bill

**Prompt Example:**

```
Tell me about the Kenya Revenue Authority Amendment Bill 2024.
```

**Expected Behavior:**

The assistant provides detailed information about the specified bill, including its description.

```
**Knowledge Graph Data:**
**Title:** The Kenya Revenue Authority Amendment Bill 2024.pdf
**Description:**
SPECIAL ISSUE 

NATIONAL COUNCIL UOR 
LAW REPORTING 
LIBRARY 

Kenya Gazette Supplement No. 101 (National Assembly Bills No. 29) 

REPUBLIC OF KENYA 

KENYA GAZETTE SUPPLEMENT 

NATIONAL ASSEMBLY BILLS, 2024 

NAIROBI, 9th May, 2024 

CONTENT 

Bill for Introduction into the National Assembly— 

The Kenya Revenue Authority (Amendment) Bill, 2024 

...

Based on the above information, provide a comprehensive and accurate response.
```

## Logging

All logs are stored in the `logs/ai_model.log` file and are also output to the console. Logging includes:

- Initialization and configuration details.
- Query results from the knowledge graph.
- API request and response statuses.
- Errors and exceptions for troubleshooting.

**Sample Log Entries:**

```
2024-10-22 23:24:27,637 - INFO - Initialized OllamaResponder with model: llama3.2:latest at http://127.0.0.1:11434
2024-10-22 23:24:27,637 - INFO - Connected to Neo4j Knowledge Graph successfully.
2024-10-22 23:24:27,637 - INFO - Returning list of bills directly without invoking AI model.
2024-10-22 23:24:27,638 - DEBUG - Augmented Prompt:
You are an assistant knowledgeable about Kenyan bills.

Here is some relevant information:
List of Bills in Kenya grouped by year:

Year 2024:
- The Kenya Revenue Authority Amendment Bill 2024.pdf
- The Tax Procedures (Amendment) Bill 2024.pdf

...

2024-10-22 23:24:27,638 - DEBUG - Sending request to Ollama API at http://127.0.0.1:11434/api/generate with payload: { ... }
```

## Troubleshooting

### Common Issues

1. **Webhook Not Reaching Flask App:**
   - **Check ngrok:** Ensure ngrok is running and the URL is correctly set in Twilio's webhook configuration.
   - **Firewall Issues:** Verify that your firewall isn't blocking incoming connections to the Flask server.

2. **Duplicate Bills in Responses:**
   - **Ensure Uniqueness in Neo4j:** Verify that each bill is uniquely represented in the knowledge graph.
   - **Code Adjustments:** The current code filters duplicates, but ensuring data integrity in Neo4j is crucial.

3. **AI Model Not Responding Correctly:**
   - **Check Ollama:** Ensure that Ollama is running and the AI model is accessible at the specified `base_url`.
   - **Logs:** Review `ai_model.log` for any errors related to AI model interactions.

4. **Connection Issues with Neo4j:**
   - **Credentials:** Confirm that the Neo4j URI, username, and password in the `.env` file are correct.
   - **Neo4j Status:** Ensure the Neo4j server is running and accessible.

### Steps to Resolve

1. **Review Logs:**
   - Check `logs/ai_model.log` for detailed error messages and stack traces.

2. **Validate Configuration:**
   - Ensure all environment variables in the `.env` file are correctly set.
   - Verify that the Twilio webhook URL matches the active ngrok URL.

3. **Test Components Individually:**
   - **Neo4j:** Use Neo4j Browser to run sample queries and confirm data integrity.
   - **Flask App:** Use tools like Postman to send test requests to the Flask endpoints.
   - **Ollama API:** Ensure the AI model is responding to API requests as expected.

4. **Recreate the Full-Text Index (If Applicable):**
   - If you opted to use Neo4j's full-text search, ensure the index is correctly created.

   ```cypher
   CALL db.index.fulltext.createNodeIndex("billTitleIndex", ["Bill"], ["title"])
   ```

## Contributing

Contributions are welcome! Please follow these steps to contribute:

1. **Fork the Repository**
2. **Create a Feature Branch**

   ```bash
   git checkout -b feature/YourFeatureName
   ```

3. **Commit Your Changes**

   ```bash
   git commit -m "Add some feature"
   ```

4. **Push to the Branch**

   ```bash
   git push origin feature/YourFeatureName
   ```

5. **Open a Pull Request**

   Provide a detailed description of your changes and the problem they solve.

## License

This project is licensed under the [MIT License](LICENSE).

## Acknowledgements

- [Twilio](https://www.twilio.com/) for the WhatsApp API.
- [Flask](https://flask.palletsprojects.com/) for the web framework.
- [Neo4j](https://neo4j.com/) for the knowledge graph database.
- [Ollama](https://ollama.com/) for the AI model integration.
- [TheFuzz](https://github.com/seatgeek/thefuzz) for fuzzy string matching.

---

*Feel free to customize this README further to better fit your project's specific needs and to add any additional sections or information as necessary.*